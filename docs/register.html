<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Registration</title>

		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
			crossorigin="anonymous"
		/>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
			crossorigin="anonymous"
		></script>
	</head>

	<body>
		<nav
			class="navbar navbar-expand-md sticky-top bg-dark"
			data-bs-theme="dark"
		>
			<div class="container">
				<a class="navbar-brand" href="index.html">Akkalkot Trip</a>
				<button
					class="navbar-toggler bg-white"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarNavAltMarkup"
					aria-controls="navbarNavAltMarkup"
					aria-expanded="false"
					aria-label="Toggle navigation"
				>
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNavAltMarkup">
					<div class="navbar-nav">
						<a class="nav-link" href="register.html">Register</a>
						<a class="nav-link" href="checkStatus.html"
							>Check status</a
						>
						<a class="nav-link" href="cancel.html">Cancel</a>
					</div>
				</div>
			</div>
		</nav>

		<div class="container py-5" id="full-reg">
			<div class="row">
				<div class="col-lg-8 offset-lg-2">
					<h1>Registration</h1>
					<h4 class="mb-2">Akkalkot-Solapur-Tuljapur Trip</h4>
					<h6 class="mb-4 text-danger text-decoration-underline">
						29<sup>th</sup> Nov to 1<sup>st</sup> Dec 2024
					</h6>
					<h6>Only those working at Worley can self-register</h6>
					<small>
						Others can register <b>only</b> through their friends in
						Worley
					</small>
					<div class="mb-4"></div>
					<form id="ver-form">
						<fieldset id="reg-fieldset">
							<div class="mb-3" id="reg-type-outer">
								<div class="mb-3 text-primary-emphasis">
									Registration type
									<span class="text-danger">*</span>
								</div>
								<div class="form-check form-check-inline">
									<input
										class="form-check-input border-1 border-dark"
										type="radio"
										name="reg_type"
										value="self"
										id="reg-self"
										onchange="regTypeChange(1)"
										checked
									/>
									<label
										class="form-check-label"
										for="reg-self"
									>
										Self (Worley employee)
									</label>
								</div>
								<div class="form-check form-check-inline">
									<input
										class="form-check-input border-1 border-dark"
										type="radio"
										name="reg_type"
										value="other"
										id="reg-other"
										onchange="regTypeChange(2)"
									/>
									<label
										class="form-check-label"
										for="reg-other"
									>
										Register for friends
									</label>
								</div>
							</div>

							<div class="mb-3">
								<label
									for="email"
									class="form-label text-primary-emphasis"
								>
									Email address (ending with @worley.com)
									<span class="text-danger">*</span>
								</label>
								<input
									type="email"
									class="form-control"
									id="email"
									name="email"
									placeholder="Enter your email"
									pattern=".*@worley.com"
									required
									oninvalid="this.setCustomValidity('Please enter a valid Worley email address')"
									oninput="this.setCustomValidity('')"
								/>
							</div>

							<div class="mb-3 d-none" id="passenger-email-outer">
								<label
									for="pass_email"
									class="form-label text-primary-emphasis"
								>
									Passenger email address
									<span class="text-danger">*</span>
								</label>
								<input
									type="email"
									class="form-control"
									id="pass_email"
									name="pass_email"
									placeholder="Enter your email"
								/>
							</div>

							<div class="mb-3">
								<label
									for="name"
									class="form-label text-primary-emphasis"
								>
									Passenger Full Name
									<span class="text-danger">*</span>
								</label>
								<input
									type="text"
									class="form-control"
									id="name"
									name="name"
									placeholder="Enter your name"
									required
								/>
							</div>

							<div class="mb-3">
								<label
									for="age"
									class="form-label text-primary-emphasis"
								>
									Passenger Age
									<span class="text-danger">*</span>
									<br />
									<small class="text-secondary-emphasis"
										>(Enter number of years only)</small
									>
								</label>
								<input
									type="text"
									class="form-control"
									id="age"
									name="age"
									placeholder="Enter your age"
									pattern="[0-9]{1,2}"
									required
								/>
							</div>

							<!-- mobile and emergency contact number side by side -->
							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label
											for="mobile"
											class="form-label text-primary-emphasis"
										>
											Mobile number of passenger
											<span class="text-danger">*</span>
											<br />
											<small
												class="text-secondary-emphasis"
												>(Only 10 digits
												<b>without</b> space OR country
												code)</small
											>
										</label>
										<input
											type="text"
											class="form-control"
											id="mobile"
											name="mobile"
											placeholder="Enter your mobile number"
											max="10"
											min="10"
											pattern="[0-9]{10}"
											required
										/>
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<label
											for="emergency"
											class="form-label text-primary-emphasis"
										>
											Emergency contact number of
											passenger
											<span class="text-danger">*</span>
											<br />
											<small
												class="text-secondary-emphasis"
												>(Only 10 digits
												<b>without</b> space OR country
												code)</small
											>
										</label>
										<input
											type="tel"
											class="form-control"
											id="emergency"
											name="emergency"
											placeholder="Emergency contact number"
											max="10"
											min="10"
											pattern="[0-9]{10}"
											required
										/>
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label
											for="boarding"
											class="form-label text-primary-emphasis"
										>
											Boarding station
											<span class="text-danger">*</span>
										</label>
										<select
											class="form-select"
											id="boarding"
											name="boarding"
											required
										>
											<option
												value="null"
												id="boarding-select"
											>
												Select
											</option>
											<option value="CSMT">CSMT</option>
											<option value="Dadar">Dadar</option>
											<option value="Thane">Thane</option>
											<option value="Kalyan">
												Kalyan
											</option>
											<option value="Pune">Pune</option>
										</select>
									</div>
								</div>

								<div class="col-md-6">
									<div class="mb-3">
										<label
											for="alighting"
											class="form-label text-primary-emphasis"
										>
											Alighting station
											<span class="text-danger">*</span>
										</label>
										<select
											class="form-select"
											id="alighting"
											name="alighting"
											required
										>
											<option
												value="null"
												id="alighting-select"
											>
												Select
											</option>
											<option value="CSMT">CSMT</option>
											<option value="Dadar">Dadar</option>
											<option value="Thane">Thane</option>
											<option value="Kalyan">
												Kalyan
											</option>
											<option value="Pune">Pune</option>
										</select>
									</div>
								</div>
							</div>

							<!-- (office & location) and department -->
							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label
											for="office_location"
											class="form-label text-primary-emphasis"
										>
											Company name/Office location of
											passenger
											<span class="text-danger">*</span>
										</label>
										<select
											class="form-select"
											id="office_location"
											name="office_location"
											required
										>
											<option
												value="null"
												id="office_location-select"
											>
												Select
											</option>
											<option value="Worley (NEH)">
												Worley (NEH)
											</option>
											<option value="Worley (Gigaplex)">
												Worley (Gigaplex)
											</option>
											<option value="JACOBS">
												JACOBS
											</option>
											<option value="Tecnimont (Malad)">
												Tecnimont (Malad)
											</option>
											<option
												value="Tecnimont (Gigaplex)"
											>
												Tecnimont (Gigaplex)
											</option>
											<option value="Toyo">Toyo</option>
											<option value="GS Engg.">
												GS Engg.
											</option>
											<option value="Burns & Mcdonell">
												Burns & Mcdonell
											</option>
											<option value="B & V">B & V</option>
											<option value="AirProduct">
												AirProduct
											</option>
											<option value="Thyssenkrup">
												Thyssenkrup
											</option>
											<option value="NPCC">NPCC</option>
											<option value="KENT">KENT</option>
											<option value="TPL">TPL</option>
											<option value="RIL">RIL</option>
											<option value="Flour">Flour</option>
											<option value="Cyient">
												Cyient
											</option>
											<option value="TCE">TCE</option>
											<option value="Technip">
												Technip
											</option>
											<option value="L & T">L & T</option>
											<option
												value="Others - Retired, Relative, etc"
											>
												Others - Retired, Relative, etc
											</option>
										</select>
									</div>
								</div>

								<div class="col-md-6">
									<div class="mb-3">
										<label
											for="department"
											class="form-label text-primary-emphasis"
										>
											Department
											<span class="text-danger">*</span>
										</label>
										<input
											type="text"
											class="form-control"
											id="department"
											name="department"
											placeholder="Enter your department"
											required
										/>
									</div>
								</div>
							</div>

							<fieldset
								id="admin-fieldset"
								class="d-none"
								disabled
							>
								<div class="mb-3">
									<label
										for="admin_password"
										class="form-label text-primary-emphasis"
										>Admin master password
										<span class="text-danger">*</span>
									</label>
									<input
										type="password"
										class="form-control"
										id="admin_password"
										required
									/>
								</div>

								<div class="form-check mb-3">
									<input
										class="form-check-input"
										type="checkbox"
										value="admin"
										id="pwl"
									/>
									<label
										class="form-check-label text-primary-emphasis"
										for="pwl"
									>
										Add to PWL
									</label>
								</div>
							</fieldset>

							<div class="mb-3" id="ver-outer">
								<button
									type="submit"
									class="btn btn-primary"
									id="ver-btn"
								>
									Send verification code
								</button>
								<div id="email-status">
									<span class="text-danger">
										Please verify email address before
										submitting
									</span>
								</div>
							</div>
						</fieldset>
					</form>

					<form action="index.html" method="POST" id="submit-form">
						<div class="mb-3 d-none" id="ver_code_outer">
							<label
								for="ver-code"
								class="form-label text-primary-emphasis"
							>
								Verification code
								<span class="text-danger">*</span>
							</label>
							<input
								type="text"
								class="form-control"
								id="ver-code"
								placeholder="6 digit"
								autocomplete="off"
								required
							/>
						</div>

						<div>
							<button
								type="submit"
								class="btn btn-success"
								id="submit-btn"
								disabled
								style="
									cursor: not-allowed;
									pointer-events: all !important;
								"
							>
								Submit
							</button>
							<div id="submit-status"></div>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div id="success-reg" class="d-none py-5">
			<div class="text-center">
				<h5 class="card-title">Registration successful</h5>
				<p class="card-text">Thank you for registering.</p>
				<p>Registration status: <b id="reg-status"></b></p>
				<p>Registration ID: <b id="reg-id" class="text-danger"></b></p>
				<p class="mb-1"><b>Save the above ID for future use</b></p>
				<p class="card-text mb-1">
					You will receive a confirmation email containing this ID.
				</p>
				<p class="card-text mb-1 text-success">
					Please contact admin to add you to WhatsApp group.
				</p>
				<p class="mb-1">
					<a
						href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTLWtk9Yfv9gfBIoSky04bpkkmATtOzUw5-buuA8w6woEVaagK9vqG6NQIAMQDYJQRe-Ek0f5lhHEQ7/pubhtml"
						target="_blank"
						>Click here to view registration sheet</a
					>
				</p>
				<p class="card-text mb-1">
					Please check your spam folder if you do not receive the
					email.
				</p>
				<p class="card-text">
					Please contact admins if you do not find the mail.
				</p>
				<p>
					<button class="btn btn-primary" onclick="location.reload()">
						Go to registration form again
					</button>
				</p>
			</div>
		</div>

		<script src="./js/index.js"></script>

		<script>
			const ignoreWorley = true;
			if (
				!location.href.includes('gurukrupadarshansahal.online') &&
				ignoreWorley
			) {
				let temp = document.getElementById('email');
				temp.removeAttribute('pattern');
				temp.removeAttribute('oninvalid');
				temp.removeAttribute('oninput');
			}

			let admin = false;
			if (location.href.includes('isadmin=true')) {
				admin = true;
			}
		</script>

		<script>
			let scode = null;

			document
				.getElementById('ver-form')
				.addEventListener('submit', (e) => {
					e.preventDefault();
					requestVerificationCode();
				});

			document
				.getElementById('submit-form')
				.addEventListener('submit', (e) => {
					e.preventDefault();
					submitForm();
				});

			let passengerOuter = document.getElementById(
				'passenger-email-outer'
			);
			let passengerEmail = document.getElementById('pass_email');

			let verBtn = document.getElementById('ver-btn');
			let verCodeOuter = document.getElementById('ver_code_outer');
			let verCode = document.getElementById('ver-code');

			let submitBtn = document.getElementById('submit-btn');

			let emailStatus = document.getElementById('email-status');
			let submitStatus = document.getElementById('submit-status');

			let regFieldset = document.getElementById('reg-fieldset');

			const changeStatus = (element, content, className) => {
				element.innerHTML =
					'<span class="' + className + '">' + content + '</span>';
			};

			const submitDisabled = (status) => {
				if (status) {
					submitBtn.setAttribute('disabled', '');
					submitBtn.style.cursor = 'not-allowed';
				} else {
					submitBtn.removeAttribute('disabled');
					submitBtn.style.cursor = 'pointer';
				}
			};

			let selfReg = true;

			const regTypeChange = (e) => {
				if (e == 1) {
					passengerOuter.classList.add('d-none');
					passengerEmail.required = false;
					selfReg = true;
				} else {
					passengerOuter.classList.remove('d-none');
					passengerEmail.required = true;
					selfReg = false;
				}
			};

			let boarding = document.getElementById('boarding');
			let alighting = document.getElementById('alighting');
			let office_location = document.getElementById('office_location');
			let emergency = document.getElementById('emergency');
			let mobile = document.getElementById('mobile');

			const requestVerificationCode = () => {
				// boarding/alighting/office must have a value
				if (boarding.value == 'null') {
					alert('Please select boarding station');
					boarding.focus();
					return;
				} else if (alighting.value == 'null') {
					alert('Please select alighting station');
					alighting.focus();
					return;
				} else if (office_location.value == 'null') {
					alert('Please select office location');
					office_location.focus();
					return;
				} else if (emergency.value == mobile.value) {
					alert('Emergency number cannot be same as mobile number');
					emergency.focus();
					return;
				}

				regFieldset.disabled = true;
				changeStatus(
					emailStatus,
					'Sending verification code...',
					'text-danger'
				);

				let email = document
					.getElementById('email')
					.value.trim()
					.toLowerCase();
				let name = document.getElementById('name').value.trim();
				let passEmail = document
					.getElementById('pass_email')
					.value.trim()
					.toLowerCase();

				let data = {
					email: email,
					passEmail: selfReg ? email : passEmail,
					reg_name: selfReg ? 'self' : name + ' (' + passEmail + ')',
					ex: 'verification'
				};

				fetch(scLink, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					body: JSON.stringify(data)
				})
					.then((res) => res.json())
					.then((data) => {
						if (data.status == 'success') {
							changeStatus(
								emailStatus,
								'Verification code sent to your email (Also check spam)<br>It is valid for <b>10 minutes</b>',
								'text-success'
							);
							verCodeOuter.classList.remove('d-none');
							submitDisabled(false);

							scode = data.code;

							setTimeout(() => {
								changeStatus(
									emailStatus,
									'<b>Verification code expired.</b><br>Please <a href="javascript:location.reload()">reload the page</a>.',
									'text-danger'
								);
								scode = null;
							}, 600000);
						} else {
							regFieldset.disabled = false;
							changeStatus(
								emailStatus,
								data.message,
								'text-danger'
							);
						}
					})
					.catch((err) => {
						regFieldset.disabled = false;
						changeStatus(
							emailStatus,
							'Verification code error! Try again.',
							'text-danger'
						);
					});
			};

			const submitForm = () => {
				submitDisabled(true);
				changeStatus(submitStatus, 'Verifying...', 'text-danger');

				if (
					document.getElementById('email').value.trim() ==
					document.getElementById('pass_email').value.trim()
				) {
					selfReg = true;
				}

				if (verCode.value.trim() != scode && !admin) {
					changeStatus(
						submitStatus,
						'Incorrect verification code!',
						'text-danger'
					);
					submitDisabled(false);
					return;
				}

				let email = selfReg
					? 'self'
					: document.getElementById('email').value.trim();
				let name = document.getElementById('name').value.trim();
				let passEmail = selfReg
					? document.getElementById('email').value.trim()
					: document.getElementById('pass_email').value.trim();

				let initialStatus = regFieldset.disabled;
				regFieldset.disabled = false;

				let verForm = document.getElementById('ver-form');
				let formData = new FormData(verForm);
				let values = Object.fromEntries(formData.entries());

				let data = {
					email: email,
					passEmail: passEmail,
					name: name,
					ex: 'registration'
				};

				if (admin) {
					data.admin = true;
					data.adminPass = document
						.getElementById('admin_password')
						.value.trim();

					data.pwl = document.getElementById('pwl').checked;
				}

				data = { ...values, ...data };

				regFieldset.disabled = initialStatus;

				fetch(scLink, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					body: JSON.stringify(data)
				})
					.then((res) => res.json())
					.then((data) => {
						if (data.status == 'success') {
							document.getElementById('full-reg').remove();
							document
								.getElementById('success-reg')
								.classList.remove('d-none');
							let statusClass = 'text-primary';
							if (data.reg == 'Confirmed') {
								statusClass = 'text-success';
							}
							document.getElementById('reg-status').innerHTML =
								'<span class="' +
								statusClass +
								'">' +
								data.reg +
								'</span>';
							document.getElementById('reg-id').innerHTML =
								data.uuid;
						} else {
							changeStatus(
								submitStatus,
								data.message,
								'text-danger'
							);
							submitDisabled(false);
						}
					})
					.catch((err) => {
						changeStatus(
							submitStatus,
							'Registration error! Try again.',
							'text-danger'
						);
						submitDisabled(false);
					});
			};
		</script>

		<script>
			if (admin) {
				let afs = document.querySelector('#admin-fieldset');
				afs.disabled = false;
				afs.classList.remove('d-none');

				document.getElementById('reg-other').click();
				document.getElementById('reg-type-outer').style.display =
					'none';

				document.getElementById('ver-outer').style.display = 'none';
				document.getElementById('submit-btn').removeAttribute('style');
				document
					.getElementById('submit-btn')
					.removeAttribute('disabled');
				document.getElementById('ver-code').removeAttribute('required');
			}
		</script>
	</body>
</html>
